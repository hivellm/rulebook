import { describe, it, expect } from 'vitest';
import { generateAgentsContent, generateFullAgents, generateGitRules } from '../src/core/generator';
import type { ProjectConfig } from '../src/types';

describe('generator', () => {
  const baseConfig: ProjectConfig = {
    languages: ['rust'],
    modules: ['vectorizer'],
    ides: ['cursor'],
    projectType: 'application',
    coverageThreshold: 95,
    strictDocs: true,
    generateWorkflows: true,
  };

  describe('generateAgentsContent', () => {
    it('should generate RULEBOOK block with project rules', async () => {
      const content = await generateAgentsContent(baseConfig);

      expect(content).toContain('<!-- RULEBOOK:START -->');
      expect(content).toContain('<!-- RULEBOOK:END -->');
      expect(content).toContain('# Project Rules');
      expect(content).toContain('Documentation Standards');
      expect(content).toContain('Testing Requirements');
      expect(content).toContain('Feature Development Workflow');
    });

    it('should include coverage threshold', async () => {
      const config = { ...baseConfig, coverageThreshold: 85 };
      const content = await generateAgentsContent(config);

      expect(content).toContain('**Minimum Coverage**: 85%');
    });

    it('should include strict documentation rules when enabled', async () => {
      const config = { ...baseConfig, strictDocs: true };
      const content = await generateAgentsContent(config);

      expect(content).toContain('Minimize Markdown files');
      expect(content).toContain('Allowed Root-Level Documentation');
      expect(content).toContain('/docs` directory');
    });

    it('should include .rulesignore documentation', async () => {
      const content = await generateAgentsContent(baseConfig);

      expect(content).toContain('Rules Configuration');
      expect(content).toContain('.rulesignore');
    });

    it('should include generated timestamp', async () => {
      const content = await generateAgentsContent(baseConfig);

      expect(content).toContain('Generated by @hivellm/rulebook');
      expect(content).toMatch(/Generated at: \d{4}-\d{2}-\d{2}T/);
    });
  });

  describe('generateFullAgents', () => {
    it('should generate complete AGENTS.md with all sections', async () => {
      const config: ProjectConfig = {
        languages: ['rust', 'typescript'],
        modules: ['vectorizer', 'synap'],
        ides: ['cursor'],
        projectType: 'application',
        coverageThreshold: 95,
        strictDocs: true,
        generateWorkflows: true,
      };

      const content = await generateFullAgents(config);

      // Should include RULEBOOK block
      expect(content).toContain('<!-- RULEBOOK:START -->');
      expect(content).toContain('<!-- RULEBOOK:END -->');

      // Should include language blocks
      expect(content).toContain('<!-- RUST:START -->');
      expect(content).toContain('<!-- RUST:END -->');
      expect(content).toContain('<!-- TYPESCRIPT:START -->');
      expect(content).toContain('<!-- TYPESCRIPT:END -->');

      // Should include module blocks
      expect(content).toContain('<!-- VECTORIZER:START -->');
      expect(content).toContain('<!-- VECTORIZER:END -->');
      expect(content).toContain('<!-- SYNAP:START -->');
      expect(content).toContain('<!-- SYNAP:END -->');
    });

    it('should generate content for single language', async () => {
      const config = { ...baseConfig };
      const content = await generateFullAgents(config);

      expect(content).toContain('<!-- RUST:START -->');
      expect(content).toContain('<!-- RUST:END -->');
      expect(content).not.toContain('<!-- TYPESCRIPT:START -->');
    });

    it('should generate content for multiple modules', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        modules: ['vectorizer', 'synap', 'context7'],
      };
      const content = await generateFullAgents(config);

      expect(content).toContain('<!-- VECTORIZER:START -->');
      expect(content).toContain('<!-- SYNAP:START -->');
      expect(content).toContain('<!-- CONTEXT7:START -->');
    });

    it('should include Git workflow when enabled', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        includeGitWorkflow: true,
        gitPushMode: 'manual',
      };
      const content = await generateFullAgents(config);

      expect(content).toContain('<!-- GIT:START -->');
      expect(content).toContain('<!-- GIT:END -->');
    });

    it('should exclude Git workflow when disabled', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        includeGitWorkflow: false,
      };
      const content = await generateFullAgents(config);

      expect(content).not.toContain('<!-- GIT:START -->');
    });
  });

  describe('generateGitRules', () => {
    it('should generate Git rules with manual push mode', async () => {
      const content = await generateGitRules('manual');

      expect(content).toContain('<!-- GIT:START -->');
      expect(content).toContain('<!-- GIT:END -->');
      expect(content).toContain('MANUAL');
      expect(content).toContain('Never execute `git push` commands automatically');
      expect(content).toContain('MANUAL ACTION REQUIRED');
    });

    it('should generate Git rules with prompt push mode', async () => {
      const content = await generateGitRules('prompt');

      expect(content).toContain('<!-- GIT:START -->');
      expect(content).toContain('PROMPT');
      expect(content).toContain('ask user permission before pushing');
    });

    it('should generate Git rules with auto push mode', async () => {
      const content = await generateGitRules('auto');

      expect(content).toContain('<!-- GIT:START -->');
      expect(content).toContain('AUTO');
      expect(content).toContain('Automatic push enabled');
      expect(content).toContain('SSH key has no password');
    });
  });

  describe('light mode', () => {
    it('should skip quality enforcement in light mode', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        lightMode: true,
      };
      const content = await generateAgentsContent(config);

      expect(content).not.toContain('QUALITY_ENFORCEMENT');
      expect(content).not.toContain('STRICTLY FORBIDDEN');
    });

    it('should include quality enforcement when not in light mode', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        lightMode: false,
      };
      const content = await generateAgentsContent(config);

      expect(content).toContain('Quality Enforcement Rules');
    });
  });

  describe('documentation strictness', () => {
    it('should use relaxed docs when strictDocs is false', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        strictDocs: false,
      };
      const content = await generateAgentsContent(config);

      expect(content).not.toContain('Minimize Markdown files');
      expect(content).toContain('well-organized');
    });
  });

  describe('frameworks and tools', () => {
    it('should include frameworks when specified', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        frameworks: ['nestjs', 'react'],
      };
      const content = await generateFullAgents(config);

      expect(content).toContain('<!-- NESTJS:START -->');
      expect(content).toContain('<!-- REACT:START -->');
    });

    it('should include CLI tools when specified', () => {
      const config: ProjectConfig = {
        ...baseConfig,
        cliTools: ['aider', 'continue'],
      };
      // Just test that config accepts CLI tools
      expect(config.cliTools).toEqual(['aider', 'continue']);
    });

    it('should handle empty frameworks array', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        frameworks: [],
      };
      const content = await generateFullAgents(config);

      expect(content).not.toContain('<!-- NESTJS:START -->');
      expect(content).not.toContain('<!-- REACT:START -->');
    });
  });

  describe('multiple IDE support', () => {
    it('should accept multiple IDEs in config', () => {
      const config: ProjectConfig = {
        ...baseConfig,
        ides: ['cursor', 'windsurf', 'vscode'],
      };
      // IDEs are used for prompts but not in generated content
      expect(config.ides).toEqual(['cursor', 'windsurf', 'vscode']);
    });
  });

  describe('project types', () => {
    it('should handle library project type', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        projectType: 'library',
      };
      const content = await generateFullAgents(config);

      expect(content).toBeDefined();
      expect(content.length).toBeGreaterThan(0);
    });

    it('should handle CLI project type', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        projectType: 'cli',
      };
      const content = await generateFullAgents(config);

      expect(content).toBeDefined();
      expect(content.length).toBeGreaterThan(0);
    });

    it('should handle monorepo project type', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        projectType: 'monorepo',
      };
      const content = await generateFullAgents(config);

      expect(content).toBeDefined();
      expect(content.length).toBeGreaterThan(0);
    });
  });
});
