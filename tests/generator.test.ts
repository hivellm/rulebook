import { describe, it, expect } from 'vitest';
import {
  generateAgentsContent,
  generateFullAgents,
  generateGitRules,
  generateModularAgents,
} from '../src/core/generator';
import type { ProjectConfig } from '../src/types';

describe('generator', () => {
  const baseConfig: ProjectConfig = {
    languages: ['rust'],
    modules: ['vectorizer'],
    ides: ['cursor'],
    projectType: 'application',
    coverageThreshold: 95,
    strictDocs: true,
    generateWorkflows: true,
  };

  describe('generateAgentsContent', () => {
    it('should generate RULEBOOK block with project rules', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        includeGitWorkflow: true,
      };
      const content = await generateAgentsContent(config);

      expect(content).toContain('<!-- RULEBOOK:START -->');
      expect(content).toContain('<!-- RULEBOOK:END -->');
      expect(content).toContain('# Project Rules');
      expect(content).toContain('Core Rules');
      expect(content).toContain('Detailed Rules');
      expect(content).toContain('/rulebook/specs/QUALITY_ENFORCEMENT.md');
      expect(content).toContain('/rulebook/specs/GIT.md');
    });

    it('should include coverage threshold', async () => {
      const config = { ...baseConfig, coverageThreshold: 85 };
      const content = await generateAgentsContent(config);

      expect(content).toContain('85%+ coverage required');
    });

    it('should include core rules summary', async () => {
      const config = { ...baseConfig, strictDocs: true };
      const content = await generateAgentsContent(config);

      expect(content).toContain('Core Rules');
      expect(content).toContain('CRITICAL RULES');
      expect(content).toContain('@hivellm/rulebook standards');
    });

    it('should include generated timestamp', async () => {
      const content = await generateAgentsContent(baseConfig);

      expect(content).toContain('Generated by @hivellm/rulebook');
      expect(content).toMatch(/Generated at: \d{4}-\d{2}-\d{2}T/);
    });
  });

  describe('generateFullAgents', () => {
    it('should generate complete AGENTS.md with all sections (modular mode)', async () => {
      const config: ProjectConfig = {
        languages: ['rust', 'typescript'],
        modules: ['vectorizer', 'synap'],
        ides: ['cursor'],
        projectType: 'application',
        coverageThreshold: 95,
        strictDocs: true,
        generateWorkflows: true,
        modular: true,
      };

      const content = await generateFullAgents(config, '/tmp/test');

      // Should include RULEBOOK block
      expect(content).toContain('<!-- RULEBOOK:START -->');
      expect(content).toContain('<!-- RULEBOOK:END -->');

      // Should include language references (not embedded blocks in modular mode)
      expect(content).toContain('Language-Specific Rules');
      expect(content).toContain('/rulebook/specs/RUST.md');
      expect(content).toContain('/rulebook/specs/TYPESCRIPT.md');

      // Should include module references
      expect(content).toContain('Module-Specific Instructions');
      expect(content).toContain('/rulebook/specs/VECTORIZER.md');
      expect(content).toContain('/rulebook/specs/SYNAP.md');
    });

    it('should generate content for single language (modular mode)', async () => {
      const config = { ...baseConfig, modular: true };
      const content = await generateFullAgents(config, '/tmp/test');

      expect(content).toContain('/rulebook/specs/RUST.md');
      expect(content).not.toContain('/rulebook/specs/TYPESCRIPT.md');
    });

    it('should generate content for multiple modules (modular mode)', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        modules: ['vectorizer', 'synap', 'context7'],
        modular: true,
      };
      const content = await generateFullAgents(config, '/tmp/test');

      expect(content).toContain('/rulebook/specs/VECTORIZER.md');
      expect(content).toContain('/rulebook/specs/SYNAP.md');
      expect(content).toContain('/rulebook/specs/CONTEXT7.md');
    });

    it('should generate embedded content in legacy mode', async () => {
      const config: ProjectConfig = {
        languages: ['rust'],
        modules: ['vectorizer'],
        ides: ['cursor'],
        projectType: 'application',
        coverageThreshold: 95,
        strictDocs: true,
        generateWorkflows: true,
        modular: false, // Explicitly disable modular
      };

      const content = await generateFullAgents(config);

      // Should include embedded blocks in legacy mode
      expect(content).toContain('<!-- RUST:START -->');
      expect(content).toContain('<!-- RUST:END -->');
      expect(content).toContain('<!-- VECTORIZER:START -->');
      expect(content).toContain('<!-- VECTORIZER:END -->');
    });

    it('should reference Git workflow in /rulebook/ when enabled', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        includeGitWorkflow: true,
        gitPushMode: 'manual',
        modular: true,
      };
      const content = await generateFullAgents(config, '/tmp/test');

      expect(content).toContain('/rulebook/specs/GIT.md');
    });

    it('should exclude Git workflow when disabled', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        includeGitWorkflow: false,
      };
      const content = await generateFullAgents(config, '/tmp/test');

      // Git workflow should not be referenced in AGENTS.md
      expect(content).not.toContain('/rulebook/specs/GIT.md');
    });
  });

  describe('generateGitRules', () => {
    it('should generate Git rules with manual push mode', async () => {
      const content = await generateGitRules('manual');

      expect(content).toContain('<!-- GIT:START -->');
      expect(content).toContain('<!-- GIT:END -->');
      expect(content).toContain('MANUAL');
      expect(content).toContain('Never execute `git push` commands automatically');
      expect(content).toContain('MANUAL ACTION REQUIRED');
    });

    it('should generate Git rules with prompt push mode', async () => {
      const content = await generateGitRules('prompt');

      expect(content).toContain('<!-- GIT:START -->');
      expect(content).toContain('PROMPT');
      expect(content).toContain('ask user permission before pushing');
    });

    it('should generate Git rules with auto push mode', async () => {
      const content = await generateGitRules('auto');

      expect(content).toContain('<!-- GIT:START -->');
      expect(content).toContain('AUTO');
      expect(content).toContain('Automatic push enabled');
      expect(content).toContain('SSH key has no password');
    });
  });

  describe('light mode', () => {
    it('should skip quality enforcement reference in light mode', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        lightMode: true,
      };
      const content = await generateAgentsContent(config);

      // QUALITY_ENFORCEMENT should not be referenced in light mode
      expect(content).not.toContain('/rulebook/specs/QUALITY_ENFORCEMENT.md');
    });

    it('should reference quality enforcement when not in light mode', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        lightMode: false,
      };
      const content = await generateAgentsContent(config);

      // Should reference QUALITY_ENFORCEMENT in /rulebook/
      expect(content).toContain('/rulebook/specs/QUALITY_ENFORCEMENT.md');
    });
  });

  describe('documentation strictness', () => {
    it('should generate core rules regardless of strictDocs', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        strictDocs: false,
      };
      const content = await generateAgentsContent(config);

      expect(content).toContain('Core Rules');
      expect(content).toContain('CRITICAL RULES');
    });
  });

  describe('frameworks and tools', () => {
    it('should include frameworks when specified (modular mode)', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        frameworks: ['nestjs', 'react'],
        modular: true,
      };
      const content = await generateFullAgents(config, '/tmp/test');

      expect(content).toContain('Framework-Specific Rules');
      expect(content).toContain('/rulebook/specs/NESTJS.md');
      expect(content).toContain('/rulebook/specs/REACT.md');
    });

    it('should include CLI tools when specified', () => {
      const config: ProjectConfig = {
        ...baseConfig,
        cliTools: ['aider', 'continue'],
      };
      // Just test that config accepts CLI tools
      expect(config.cliTools).toEqual(['aider', 'continue']);
    });

    it('should handle empty frameworks array', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        frameworks: [],
      };
      const content = await generateFullAgents(config);

      expect(content).not.toContain('<!-- NESTJS:START -->');
      expect(content).not.toContain('<!-- REACT:START -->');
    });

    it('should handle undefined frameworks', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        frameworks: undefined,
      };
      const content = await generateFullAgents(config);

      expect(content).toBeDefined();
      expect(content.length).toBeGreaterThan(0);
    });

    it('should reference Git workflow in /rulebook/ when includeGitWorkflow is true', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        includeGitWorkflow: true,
        gitPushMode: 'manual',
        modular: true,
      };
      const content = await generateFullAgents(config, '/tmp/test');

      // Should reference GIT.md in /rulebook/
      expect(content).toContain('/rulebook/specs/GIT.md');
    });

    it('should not reference Git workflow when includeGitWorkflow is false', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        includeGitWorkflow: false,
        modular: true,
      };
      const content = await generateFullAgents(config, '/tmp/test');

      // Git workflow should not be referenced
      expect(content).not.toContain('/rulebook/specs/GIT.md');
    });

    it('should use default gitPushMode when not specified', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        includeGitWorkflow: true,
        modular: true,
        // gitPushMode not specified
      };
      const content = await generateFullAgents(config, '/tmp/test');

      // Should reference GIT.md
      expect(content).toContain('/rulebook/specs/GIT.md');
    });
  });

  describe('generateModularAgents branch coverage', () => {
    it('should handle empty languages array', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        languages: [],
        modular: true,
      };
      const content = await generateModularAgents(config, '/tmp/test');

      expect(content).toContain('<!-- RULEBOOK:START -->');
      expect(content).not.toContain('## Language-Specific Rules');
    });

    it('should handle empty frameworks array', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        frameworks: [],
        modular: true,
      };
      const content = await generateModularAgents(config, '/tmp/test');

      expect(content).toContain('<!-- RULEBOOK:START -->');
      expect(content).not.toContain('## Framework-Specific Rules');
    });

    it('should handle undefined frameworks', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        frameworks: undefined,
        modular: true,
      };
      const content = await generateModularAgents(config, '/tmp/test');

      expect(content).toContain('<!-- RULEBOOK:START -->');
      expect(content).not.toContain('## Framework-Specific Rules');
    });

    it('should handle minimal mode', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        minimal: true,
        modular: true,
      };
      const content = await generateModularAgents(config, '/tmp/test');

      expect(content).toContain('<!-- RULEBOOK:START -->');
      // AGENT_AUTOMATION should not be included in minimal mode
    });

    it('should handle empty modules array', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        modules: [],
        modular: true,
      };
      const content = await generateModularAgents(config, '/tmp/test');

      expect(content).toContain('<!-- RULEBOOK:START -->');
      // With minimal mode, modules section should not appear (agent_automation is excluded)
      // But if there are other modules, it might appear - check is flexible
    });

    it('should reference Git workflow in /rulebook/ when includeGitWorkflow is true', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        includeGitWorkflow: true,
        gitPushMode: 'manual',
        modular: true,
      };
      const content = await generateModularAgents(config, '/tmp/test');

      expect(content).toContain('/rulebook/specs/GIT.md');
    });

    it('should not reference Git workflow when includeGitWorkflow is false', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        includeGitWorkflow: false,
        modular: true,
      };
      const content = await generateModularAgents(config, '/tmp/test');

      expect(content).toContain('<!-- RULEBOOK:START -->');
      expect(content).not.toContain('/rulebook/specs/GIT.md');
    });

    it('should use custom rulebookDir', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        rulebookDir: 'custom-rulebook',
        modular: true,
        includeGitWorkflow: true,
        languages: ['typescript'],
      };
      const testDir = '/tmp/test-custom-dir';
      const content = await generateModularAgents(config, testDir);

      // The reference paths should use custom-rulebook
      expect(content).toContain('/custom-rulebook/specs/GIT.md');
      expect(content).toContain('/custom-rulebook/specs/TYPESCRIPT.md');
    });
  });

  describe('generateFullAgents legacy mode', () => {
    it('should use legacy mode when modular is false', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        languages: ['typescript'],
        modular: false, // Explicitly disable modular
        includeGitWorkflow: false, // Disable to avoid /rulebook/ references
        lightMode: true, // Disable to avoid /rulebook/QUALITY_ENFORCEMENT.md reference
      };
      const content = await generateFullAgents(config);

      // Should embed content, not use references
      expect(content).toContain('<!-- TYPESCRIPT:START -->');
      // In legacy mode, content is embedded directly
    });

    it('should handle minimal mode in legacy', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        modular: false,
        minimal: true,
      };
      const content = await generateFullAgents(config);

      expect(content).toBeDefined();
      // AGENT_AUTOMATION should not be included
    });

    it('should handle includeGitWorkflow in legacy mode', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        modular: false,
        includeGitWorkflow: true,
        gitPushMode: 'auto',
      };
      const content = await generateFullAgents(config);

      // In legacy mode, Git rules are embedded
      expect(content).toContain('<!-- GIT:START -->');
    });
  });

  describe('multiple IDE support', () => {
    it('should accept multiple IDEs in config', () => {
      const config: ProjectConfig = {
        ...baseConfig,
        ides: ['cursor', 'windsurf', 'vscode'],
      };
      // IDEs are used for prompts but not in generated content
      expect(config.ides).toEqual(['cursor', 'windsurf', 'vscode']);
    });
  });

  describe('project types', () => {
    it('should handle library project type', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        projectType: 'library',
      };
      const content = await generateFullAgents(config);

      expect(content).toBeDefined();
      expect(content.length).toBeGreaterThan(0);
    });

    it('should handle CLI project type', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        projectType: 'cli',
      };
      const content = await generateFullAgents(config);

      expect(content).toBeDefined();
      expect(content.length).toBeGreaterThan(0);
    });

    it('should handle monorepo project type', async () => {
      const config: ProjectConfig = {
        ...baseConfig,
        projectType: 'monorepo',
      };
      const content = await generateFullAgents(config);

      expect(content).toBeDefined();
      expect(content.length).toBeGreaterThan(0);
    });
  });
});
